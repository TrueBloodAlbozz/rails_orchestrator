# Rails 8 Authentication Guide - 2024/2025 Best Practices

## Overview

Rails 8 introduces a built-in authentication generator that provides a secure, lightweight alternative to gems like Devise. This guide covers implementation using modern best practices from 2024-2025.

## Why Rails 8 Built-in Authentication?

- **Transparent**: All code is in your app, easy to customize
- **Lightweight**: Only what you need, no bloat
- **Secure**: BCrypt hashing, signed cookies, rate limiting
- **Maintained**: Part of Rails core, official support

## Prerequisites

```bash
# Ensure you have Rails 8+
rails --version  # Should be 8.0.0 or higher

# Install bcrypt gem (add to Gemfile if not present)
gem 'bcrypt', '~> 3.1.7'
```

## What's Included vs What You Need to Add

### ‚úÖ Generated by `rails generate authentication`:

| Feature | Included? | Description |
|---------|-----------|-------------|
| User model | ‚úÖ Yes | Basic model with `has_secure_password` and email normalization |
| Session model | ‚úÖ Yes | Tracks user sessions with unique tokens |
| Login/Logout | ‚úÖ Yes | SessionsController with views |
| Password Reset | ‚úÖ Yes | PasswordsController with secure token-based reset |
| Rate Limiting | ‚úÖ Yes | IP-based brute-force protection (10/3min) |
| CSRF Protection | ‚úÖ Yes | Built into Rails by default |
| Authentication Concern | ‚úÖ Yes | Helper methods for controllers |
| Current Model | ‚úÖ Yes | Access current user via `Current.user` |

### ‚ùå NOT Generated (Must Add Manually):

| Feature | Included? | What to Do |
|---------|-----------|-----------|
| User Registration | ‚ùå No | Create RegistrationsController (Step 5) |
| Password Validation | ‚ùå No | Add minimum length & complexity (Step 6) |
| Email Validation | ‚ùå No | Add presence & uniqueness validations |
| Email Confirmation | ‚ùå No | Implement separately if needed |
| Account Lockout | ‚ùå No | Optional enhancement (Step 7) |
| Multi-Factor Auth (2FA) | ‚ùå No | Use gems like `rotp` |
| OAuth/Social Login | ‚ùå No | Use `omniauth` gem |
| Session Expiration | ‚ùå No | Configure manually (Step 4) |

**Key Takeaway**: Rails 8 auth generator gives you a **secure starting point**, not a complete solution. You'll need to add registration, validations, and other features based on your needs.

## Step 1: Generate Authentication

```bash
bin/rails generate authentication
```

This creates:
- **User model**: `app/models/user.rb` with `has_secure_password`
- **Session model**: `app/models/session.rb` for session tracking
- **SessionsController**: Handles login/logout
- **PasswordsController**: Manages password resets
- **Migrations**: For users and sessions tables
- **Views**: Login and password reset forms

## Step 2: Run Migrations

```bash
bin/rails db:migrate
```

## Step 3: Understanding Generated Code

### User Model (`app/models/user.rb`)

**‚úÖ Generated by Rails 8:**

```ruby
class User < ApplicationRecord
  has_secure_password
  has_many :sessions, dependent: :destroy

  normalizes :email_address, with: ->(e) { e.strip.downcase }
end
```

**Key Features**:
- `has_secure_password`: BCrypt password hashing, automatic `password` and `password_confirmation` attributes
- `normalizes`: Email normalization (Rails 7.1+ feature) - strips whitespace and converts to lowercase
- **Important**: NO validations are generated by default (except those built into `has_secure_password`)

**‚ûï Recommended to Add:**

```ruby
class User < ApplicationRecord
  has_secure_password
  has_many :sessions, dependent: :destroy

  normalizes :email_address, with: ->(e) { e.strip.downcase }

  # Add these validations manually for production apps:
  validates :email_address, presence: true, uniqueness: true
  validates :password, length: { minimum: 12 }, allow_nil: true
end
```

**Why add validations?**
- Email validation prevents duplicate accounts
- Password minimum length (12+ chars) is a 2024/2025 security best practice
- `allow_nil: true` prevents validation errors on existing users

### Session Model (`app/models/session.rb`)

**‚úÖ Generated by Rails 8:**

```ruby
class Session < ApplicationRecord
  belongs_to :user
end
```

**üìù Note on Token Generation:**

The Rails 8 generator creates a migration with `token:token` type, which automatically:
- Adds a unique index on the token column
- The Session model uses `has_secure_token` (may or may not be explicitly in generated code, but functionality is there)

**Token generation happens via:**
```ruby
# Rails handles this automatically through the migration's token:token type
# Each session gets a unique 24+ character token using SecureRandom.base58
```

**Security Features**:
- Tracks IP address and user agent (stored in sessions table)
- Unique token per session (enforced by database index)
- Database-backed for explicit control and session management
- Tokens generated via `has_secure_token` use SecureRandom for cryptographic security

## Step 4: Enhance Security Configuration

**‚ö†Ô∏è IMPORTANT**: The following configurations are NOT generated by Rails 8. You must add them manually.

### Configure Session Store (`config/initializers/session_store.rb`)

**‚ûï Create this file manually:**

```ruby
# config/initializers/session_store.rb
Rails.application.config.session_store :cookie_store,
  key: '_your_app_session',
  expire_after: 12.hours,
  secure: Rails.env.production?,
  httponly: true,
  same_site: :lax
```

**2024/2025 Best Practices**:
- `secure: true`: HTTPS-only in production (prevents man-in-the-middle attacks)
- `httponly: true`: Prevents JavaScript access (XSS protection)
- `same_site: :lax`: CSRF protection while allowing some cross-site requests
- `expire_after: 12.hours`: Session timeout for security (adjust based on your needs)

### Force SSL in Production (`config/environments/production.rb`)

```ruby
config.force_ssl = true
```

## Step 5: Add User Registration (Not Included by Default)

**‚ö†Ô∏è Important**: The Rails 8 auth generator does NOT include user registration. You must add it manually.

**Create `app/controllers/registrations_controller.rb`:**

```ruby
class RegistrationsController < ApplicationController
  allow_unauthenticated_access only: [:new, :create]

  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)

    if @user.save
      start_new_session_for @user
      redirect_to root_path, notice: "Welcome! You have signed up successfully."
    else
      render :new, status: :unprocessable_entity
    end
  end

  private

  def user_params
    params.require(:user).permit(:email_address, :password, :password_confirmation)
  end
end
```

**Key Points**:
- `allow_unauthenticated_access`: Allows access without login (generated by Rails 8)
- `start_new_session_for @user`: Helper method from generated Authentication concern
  - Creates a Session record with user agent and IP address
  - Sets a signed, permanent cookie
  - Sets `Current.session` for the request

**Add routes (`config/routes.rb`):**

```ruby
resource :registration, only: [:new, :create]
```

**Create the registration view (`app/views/registrations/new.html.erb`):**

```erb
<h1>Sign Up</h1>

<%= form_with model: @user, url: registration_path do |form| %>
  <% if @user.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(@user.errors.count, "error") %> prohibited this user from being saved:</h2>
      <ul>
        <% @user.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :email_address %>
    <%= form.email_field :email_address, required: true, autofocus: true %>
  </div>

  <div>
    <%= form.label :password %>
    <%= form.password_field :password, required: true %>
  </div>

  <div>
    <%= form.label :password_confirmation %>
    <%= form.password_field :password_confirmation, required: true %>
  </div>

  <div>
    <%= form.submit "Sign Up" %>
  </div>
<% end %>

<p>
  Already have an account? <%= link_to "Log in", new_session_path %>
</p>
```

## Step 6: Strengthen Password Validation

**üîß Optional but Highly Recommended:**

The generated User model has NO password complexity requirements. Add strong password validation for production:

```ruby
# app/models/user.rb
class User < ApplicationRecord
  has_secure_password
  has_many :sessions, dependent: :destroy

  normalizes :email_address, with: ->(e) { e.strip.downcase }

  validates :email_address, presence: true, uniqueness: true
  validates :password,
    length: { minimum: 12 },
    format: {
      with: /\A(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])/,
      message: "must include uppercase, lowercase, number, and special character"
    },
    allow_nil: true  # Important: prevents errors on existing records
end
```

**Why these requirements?**
- **12+ characters**: NIST 2024 recommendation minimum
- **Complexity**: Mixed case, numbers, special chars prevent dictionary attacks
- **allow_nil: true**: Only validates when password is being set/changed

## Step 7: Implement Rate Limiting

**‚úÖ The generated `SessionsController` includes basic rate limiting:**

```ruby
rate_limit to: 10, within: 3.minutes, only: :create
```

This protects against brute-force attacks by limiting login attempts to 10 per 3 minutes per IP address.

**üîß Optional Enhancement: Add Account Lockout**

For additional security, you can add account-level lockout (not just IP-based):

**Step 1: Add columns to users table**

```bash
rails generate migration AddLockableToUsers failed_attempts:integer locked_at:datetime
rails db:migrate
```

**Step 2: Add methods to User model**

```ruby
# app/models/user.rb
class User < ApplicationRecord
  has_secure_password
  has_many :sessions, dependent: :destroy

  normalizes :email_address, with: ->(e) { e.strip.downcase }

  # Account lockout methods
  def increment_failed_attempts
    self.failed_attempts ||= 0
    self.failed_attempts += 1
    self.locked_at = Time.current if failed_attempts >= 5
    save
  end

  def reset_failed_attempts
    update(failed_attempts: 0, locked_at: nil)
  end

  def locked?
    locked_at.present? && locked_at > 1.hour.ago
  end
end
```

**Step 3: Update SessionsController to use lockout**

```ruby
# app/controllers/sessions_controller.rb
def create
  user = User.find_by(email_address: params[:email_address])

  if user&.locked?
    redirect_to new_session_path, alert: "Account locked. Try again later."
  elsif user&.authenticate(params[:password])
    user.reset_failed_attempts
    # ... rest of successful login logic
  else
    user&.increment_failed_attempts
    redirect_to new_session_path, alert: "Invalid email or password"
  end
end
```

## Step 8: Password Reset Security

The generated `PasswordsController` uses Rails 8's new `password_reset_token`:

```ruby
# Generate token (automatically expires in 15 minutes)
token = user.password_reset_token

# Find user by token
user = User.find_by_password_reset_token(params[:token])
```

**Key Security Features**:
- Signed tokens using `ActiveSupport::MessageVerifier`
- 15-minute expiration (configurable)
- No database storage needed
- Purpose-limited (can't be used for other purposes)

## Step 9: Log Security Events

```ruby
# app/models/concerns/auditable.rb
module Auditable
  extend ActiveSupport::Concern

  included do
    after_create :log_creation
  end

  private

  def log_creation
    Rails.logger.info "[SECURITY] #{self.class.name} created: #{self.id}"
  end
end

# Include in Session model
class Session < ApplicationRecord
  include Auditable

  after_destroy do
    Rails.logger.info "[SECURITY] Session destroyed: user_id=#{user_id}"
  end
end
```

## Step 10: Testing Authentication

```ruby
# test/models/user_test.rb
require "test_helper"

class UserTest < ActiveSupport::TestCase
  test "should not save user without email" do
    user = User.new(password: "SecurePassword123!")
    assert_not user.save
  end

  test "should require minimum password length" do
    user = User.new(email_address: "test@example.com", password: "short")
    assert_not user.save
  end

  test "should authenticate with correct password" do
    user = users(:one)
    assert user.authenticate("password")
  end
end
```

## Additional Security Best Practices (2024/2025)

### 1. Email Verification
Add email confirmation before allowing login:

```ruby
# Add to users table
add_column :users, :email_confirmed_at, :datetime
```

### 2. Multi-Factor Authentication (MFA)
Consider adding TOTP-based 2FA using `rotp` gem for sensitive applications.

### 3. Session Management
Provide users ability to view and revoke active sessions:

```ruby
# app/controllers/sessions_controller.rb
def index
  @sessions = Current.user.sessions
end

def destroy_all
  Current.user.sessions.where.not(id: Current.session.id).destroy_all
  redirect_to sessions_path, notice: "All other sessions have been logged out."
end
```

### 4. CSRF Protection
Rails enables this by default. Never disable:

```ruby
# Keep this enabled in ApplicationController
protect_from_forgery with: :exception
```

### 5. Content Security Policy
Add CSP headers (`config/initializers/content_security_policy.rb`):

```ruby
Rails.application.config.content_security_policy do |policy|
  policy.default_src :self, :https
  policy.script_src  :self, :https
  policy.style_src   :self, :https, :unsafe_inline
end
```

## Common Misconceptions ‚ö†Ô∏è

### What Rails 8 Authentication Generator DOES NOT Include:

1. **‚ùå User Registration**: Generator only handles login/logout for existing users
   - You must manually create a RegistrationsController (see Step 5)
   - No sign-up forms or views are generated

2. **‚ùå Password Complexity Validation**: Generator includes NO password requirements
   - No minimum length validation (only BCrypt's 72-char max)
   - No complexity requirements (uppercase, numbers, special chars)
   - You must add these manually (see Step 6)

3. **‚ùå Email Validation**: No email format or uniqueness validation
   - Only `normalizes` is included (lowercase, strip whitespace)
   - You must add presence and uniqueness validations manually

4. **‚ùå Email Verification/Confirmation**: No email confirmation flow
   - Users can log in immediately after registration
   - Must implement email confirmation separately if needed

5. **‚ùå Multi-Factor Authentication (MFA)**: No 2FA support out of the box
   - Consider gems like `rotp` or `two_factor_authentication` for MFA

6. **‚ùå Account Lockout**: Only IP-based rate limiting included
   - Account-level lockout requires manual implementation (see Step 7)

7. **‚ùå OAuth/Social Login**: No third-party authentication
   - Must use gems like `omniauth` for Google, GitHub, etc.

8. **‚ùå Session Store Configuration**: Default Rails session config used
   - Must manually configure session expiration, security flags (see Step 4)

**üí° Bottom Line**: Rails 8 generator provides a **minimal foundation**. It's intentionally lightweight to give you control and avoid bloat.

## Common Pitfalls to Avoid

1. **Don't store passwords in plain text**: Always use `has_secure_password`
2. **Don't assume validations exist**: Generated User model has minimal validations
3. **Don't skip CSRF protection**: Keep `protect_from_forgery` enabled
4. **Don't ignore rate limiting**: The generated rate limit is per-IP, consider account-level lockout
5. **Don't use `http` in production**: Always use HTTPS with `force_ssl = true`
6. **Don't store sensitive data in cookies**: Use signed/encrypted cookies only
7. **Don't reuse password reset tokens**: They expire after 15 minutes by default
8. **Don't forget to test**: Add tests for authentication, lockout, password reset flows

## Production Checklist

- [ ] `force_ssl = true` enabled
- [ ] Session cookies are `secure`, `httponly`, and `same_site`
- [ ] Rate limiting configured on login
- [ ] Password complexity requirements enforced
- [ ] Email verification implemented
- [ ] Security events logged
- [ ] Session expiration configured
- [ ] CSRF protection enabled
- [ ] Content Security Policy configured
- [ ] Regular security audits scheduled

## Resources

- [Rails Security Guide](https://guides.rubyonrails.org/security.html)
- [Rails 8 Authentication Generator Documentation](https://blog.saeloun.com/2025/05/12/rails-8-adds-built-in-authentication-generator/)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)

---

**Last Updated**: November 2025 | Based on Rails 8.0+ best practices
